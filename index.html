<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CAN Bus Real-time Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; max-width: 1200px; margin: 20px auto; }
        .metric { background-color: #fff; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .metric .label { font-size: 0.9em; color: #666; margin-bottom: 5px; white-space: nowrap; }
        .metric .value { font-size: 2em; font-weight: bold; color: #333; font-family: monospace; }
        .fuel-section { grid-column: 1 / -1; } 
        .fuel-section h3 { text-align: center; color: #555; margin-top: 20px; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px;}
        .fuel-metrics { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px;}
        #status-message { text-align: center; margin-top: 1em; height: 1.2em; font-weight: bold; }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-database-compat.js"></script>
</head>
<body>
    <h2 style="text-align: center; color: #FF69B4;">ãŸã‘ã¡ã‚ƒã‚“ã‚»ãƒ³ã‚µãƒ¼ğŸ’˜</h2>
    <p id="status-message">Firebaseã«æ¥ç¶šä¸­...</p>

    <div class="dashboard">
        <!-- ã‚¨ãƒ³ã‚¸ãƒ³åŸºæœ¬æƒ…å ± -->
        <div class="metric"><div class="label">RPM</div><div class="value" id="data-rpm">-</div></div>
        <div class="metric"><div class="label">TPS (%)</div><div class="value" id="data-tps">-</div></div>
        <div class="metric"><div class="label">è»Šé€Ÿ (km/h)</div><div class="value" id="data-kph">-</div></div>
        <div class="metric"><div class="label">ã‚®ã‚¢</div><div class="value" id="data-gear">-</div></div>
        <div class="metric"><div class="label">ã‚¨ãƒ³ã‚¸ãƒ³æ°´æ¸© (Â°C)</div><div class="value" id="data-water_temp">-</div></div>
        <div class="metric"><div class="label">å¸æ°—æ¸©åº¦ (Â°C)</div><div class="value" id="data-air_temp">-</div></div>
        <div class="metric"><div class="label">MAP (kPa)</div><div class="value" id="data-map_kpa">-</div></div>
        <div class="metric"><div class="label">A/F (Lambda)</div><div class="value" id="data-lambda">-</div></div>
        <div class="metric"><div class="label">æ²¹åœ§ (kPa)</div><div class="value" id="data-oil_p">-</div></div>
        <div class="metric"><div class="label">æ²¹æ¸© (Â°C)</div><div class="value" id="data-oil_temp">-</div></div>
        <div class="metric"><div class="label">ç‡ƒåœ§ (kPa)</div><div class="value" id="data-fuel_p">-</div></div>
        <div class="metric"><div class="label">é›»åœ§ (V)</div><div class="value" id="data-volts">-</div></div>
        <div class="metric"><div class="label">ã‚¯ãƒ©ãƒ³ã‚¯ã‚¨ãƒ©ãƒ¼</div><div class="value" id="data-crank_errors">-</div></div>
        <div class="metric"><div class="label">ã‚«ãƒ ã‚¨ãƒ©ãƒ¼</div><div class="value" id="data-cam_errors">-</div></div>

        <!-- ç‡ƒæ–™æ¶ˆè²»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="fuel-section">
            <h3>ç‡ƒæ–™æ¶ˆè²»ãƒ‡ãƒ¼ã‚¿</h3>
            <div class="fuel-metrics">
                <div class="metric"><div class="label">å™´å°„æ™‚é–“ (ms)</div><div class="value" id="data-injection_ms">-</div></div>
                <div class="metric"><div class="label">è¨ˆç®— æµé‡ (g/s)</div><div class="value" id="data-calc_fuel_gs">-</div></div>
                <div class="metric"><div class="label">è¨ˆç®— æµé‡ (L/Hr)</div><div class="value" id="data-calc_fuel_lph">-</div></div>
                <div class="metric"><div class="label">ç·æ¶ˆè²»é‡ (L)</div><div class="value" id="data-total_fuel_l">-</div></div>
                <div class="metric"><div class="label">ECU æµé‡ (L/Hr)</div><div class="value" id="data-fuel_lph">-</div></div>
            </div>
        </div>
    </div>

    <script>
        // â˜…â˜…â˜… Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šæƒ…å ±ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ â˜…â˜…â˜…
        const firebaseConfig = {
            apiKey: "AIzaSyBjCn1IyhP_t6c7UQ0ngCaytpQdRfolgQo",
            authDomain: "take-chan-sensor.firebaseapp.com",
            databaseURL: "https://take-chan-sensor-default-rtdb.asia-southeast1.firebasedatabase.app/", // Realtime Databaseã®URL
            projectId: "take-chan-sensor",
            storageBucket: "take-chan-sensor.firebasestorage.app",
            messagingSenderId: "627148894120",
            appId: "1:627148894120:web:a2218a8028e96d9ac0779d"
        };

        // Firebaseã‚’åˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const statusMessage = document.getElementById('status-message');

        // Realtime Databaseã®ãƒ‘ã‚¹ã‚’ç›£è¦–
        const dataRef = database.ref('livedata/dashboard');
        dataRef.on('value', (snapshot) => {
            if (snapshot.exists()) {
                statusMessage.textContent = 'âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿å—ä¿¡ä¸­';
                const data = snapshot.val();
                
                // ãƒ‡ãƒ¼ã‚¿ã§ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°
                Object.keys(data).forEach(key => {
                    const element = document.getElementById(`data-${key}`);
                    if (element) {
                         // ç‰¹å®šã®ã‚­ãƒ¼ã¯å°æ•°ç‚¹ä»¥ä¸‹ã®æ¡æ•°ã‚’èª¿æ•´ã—ã¦è¦‹ã‚„ã™ãã™ã‚‹
                         if (key === 'total_fuel_l' || key === 'calc_fuel_lph' || key === 'calc_fuel_gs') {
                            element.textContent = parseFloat(data[key]).toFixed(4);
                        } else if (key === 'lambda') {
                            element.textContent = parseFloat(data[key]).toFixed(3);
                        } else {
                            element.textContent = data[key];
                        }
                    }
                });
            } else {
                statusMessage.textContent = 'âŒ› ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ESP32ãŒãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            }
        }, (error) => {
            statusMessage.textContent = `âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`;
            console.error("Firebaseã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: ", error);
        });
    </script>
</body>
</html>

