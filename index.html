<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CAN Bus Real-time Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; max-width: 1000px; margin: 20px auto; }
        .metric { background-color: #fff; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .metric .label { font-size: 0.9em; color: #666; margin-bottom: 5px; }
        .metric .value { font-size: 2em; font-weight: bold; color: #333; font-family: monospace; }
        .controls { text-align: center; margin-bottom: 20px; }
        button { font-size: 1em; padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; background-color: #007bff; color: white; }
        button:hover { background-color: #0056b3; }
        #status-message { text-align: center; margin-top: 1em; height: 1.2em; }
    </style>
</head>
<body>
    <h2 style="text-align: center;">CAN Bus Real-time Dashboard</h2>
    <div class="controls">
        <button onclick="startSerial()">接続</button>
        <button onclick="stopSerial()">切断</button>
    </div>
    <p id="status-message"></p>

    <div class="dashboard">
        <div class="metric"><div class="label">RPM</div><div class="value" id="data-rpm">-</div></div>
        <div class="metric"><div class="label">TPS (%)</div><div class="value" id="data-tps">-</div></div>
        <div class="metric"><div class="label">車速 (km/h)</div><div class="value" id="data-kph">-</div></div>
        <div class="metric"><div class="label">ギア</div><div class="value" id="data-gear">-</div></div>
        <div class="metric"><div class="label">エンジン水温 (°C)</div><div class="value" id="data-water_temp">-</div></div>
        <div class="metric"><div class="label">吸気温度 (°C)</div><div class="value" id="data-air_temp">-</div></div>
        <div class="metric"><div class="label">MAP (kPa)</div><div class="value" id="data-map_kpa">-</div></div>
        <div class="metric"><div class="label">A/F (Lambda)</div><div class="value" id="data-lambda">-</div></div>
        <div class="metric"><div class="label">油圧 (kPa)</div><div class="value" id="data-oil_p">-</div></div>
        <div class="metric"><div class="label">油温 (°C)</div><div class="value" id="data-oil_temp">-</div></div>
        <div class="metric"><div class="label">燃圧 (kPa)</div><div class="value" id="data-fuel_p">-</div></div>
        <div class="metric"><div class="label">電圧 (V)</div><div class="value" id="data-volts">-</div></div>
        <div class="metric"><div class="label">クランクエラー</div><div class="value" id="data-crank_errors">-</div></div>
        <div class="metric"><div class="label">カムエラー</div><div class="value" id="data-cam_errors">-</div></div>
    </div>

    <script>
        let port;
        let reader;
        let readableStreamClosed;
        let keepReading = true;

        class LineBreakTransformer {
            constructor() { this.container = ''; }
            transform(chunk, controller) {
                this.container += chunk;
                const lines = this.container.split('\r\n');
                this.container = lines.pop();
                lines.forEach(line => controller.enqueue(line));
            }
            flush(controller) { controller.enqueue(this.container); }
        }

        async function startSerial() {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 }); // Arduinoのボーレートと合わせる
                document.getElementById("status-message").textContent = "✅ 接続しました";
                keepReading = true;
                readUntilClosed();
            } catch (error) {
                document.getElementById("status-message").textContent = `❌ 接続エラー: ${error.message}`;
            }
        }

        async function readUntilClosed() {
            const textDecoder = new TextDecoderStream();
            readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
            reader = textDecoder.readable
                .pipeThrough(new TransformStream(new LineBreakTransformer()))
                .getReader();

            while (port.readable && keepReading) {
                const { value, done } = await reader.read();
                if (done) break;

                try {
                    const data = JSON.parse(value);
                    Object.keys(data).forEach(key => {
                        const element = document.getElementById(`data-${key}`);
                        if (element) {
                            element.textContent = data[key];
                        }
                    });
                } catch (e) {
                    console.warn("無効なJSONを受信しました:", value);
                }
            }
        }

        async function stopSerial() {
            keepReading = false;
            if (reader) {
                try { await reader.cancel(); } catch (error) { /* 無視 */ }
            }
            if (readableStreamClosed) {
                await readableStreamClosed.catch(() => {});
            }
            if (port) {
                await port.close();
                document.getElementById("status-message").textContent = "🔌 切断しました";
            }
        }
    </script>
</body>
</html>
