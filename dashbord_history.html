<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CAN Bus History Graph</title>
    <!-- ã‚°ãƒ©ãƒ•æç”»ãƒ©ã‚¤ãƒ–ãƒ©ãƒª Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- â˜…â˜…â˜… æ©Ÿèƒ½è¿½åŠ : Chart.jsã®ã‚ºãƒ¼ãƒ ï¼†ãƒ‘ãƒ³ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ â˜…â˜…â˜… -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: #1a1a1a;
            color: #e0e0e0;
            margin: 0; 
            padding: 20px; 
        }
        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .header img {
            height: 50px;
        }
        .header h2 {
            margin: 0;
            text-align: center; 
            color: #FF69B4;
        }
        .nav-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .nav-button {
            background-color: #00ffc8;
            color: #1a1a1a;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            display: inline-block;
            transition: background-color 0.2s;
        }
        .nav-button:hover {
            background-color: #5effe0;
        }
        .chart-container {
            max-width: 1200px;
            margin: 0 auto 20px auto;
            background-color: #2c2c2c;
            padding: 20px;
            border-radius: 8px;
        }
        .chart-container h3 {
            margin-top: 0;
            text-align: center;
            color: #ccc;
            font-weight: normal;
        }
        /* â˜…è¿½åŠ : ã‚°ãƒ©ãƒ•æ“ä½œã®æ¡ˆå†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .chart-info {
            text-align: center;
            font-size: 0.9em;
            color: #888;
            margin-top: -10px;
            margin-bottom: 20px;
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-database-compat.js"></script>
</head>
<body>
    <div class="header">
        <img src="./OFRACãƒ­ã‚´.png" alt="OFRAC Logo">
        <h2>ãŸã‘ã¡ã‚ƒã‚“ã‚»ãƒ³ã‚µãƒ¼ğŸ’˜ (å±¥æ­´ã‚°ãƒ©ãƒ•)</h2>
    </div>

    <div class="nav-container">
        <a href="./index.html" target="_blank" class="nav-button">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã¸åˆ‡ã‚Šæ›¿ãˆ</a>
    </div>

    <p class="chart-info">ã‚°ãƒ©ãƒ•ä¸Šã§ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã‚’ä½¿ã†ã¨ã‚ºãƒ¼ãƒ ã€ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆãƒ‘ãƒ³ï¼‰ãŒã§ãã¾ã™ã€‚</p>

    <div class="chart-container">
        <h3>ã‚¨ãƒ³ã‚¸ãƒ³å›è»¢æ•° (RPM)</h3>
        <canvas id="rpmChart"></canvas>
    </div>

    <div class="chart-container">
        <h3>ã‚¹ãƒ­ãƒƒãƒˆãƒ«ãƒã‚¸ã‚·ãƒ§ãƒ³ (TPS)</h3>
        <canvas id="tpsChart"></canvas>
    </div>

    <div class="chart-container">
        <h3>ç©ºç‡ƒæ¯” (A/F Lambda)</h3>
        <canvas id="afChart"></canvas>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBjCn1IyhP_t6c7UQ0ngCaytpQdRfolgQo",
            authDomain: "take-chan-sensor.firebaseapp.com",
            databaseURL: "https://take-chan-sensor-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "take-chan-sensor",
            storageBucket: "take-chan-sensor.appspot.com",
            messagingSenderId: "627148894120",
            appId: "1:627148894120:web:a2218a8028e96d9ac0779d"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        function createChart(ctx, chartLabel, borderColor, yAxisTitle, yMin, yMax) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: chartLabel,
                        data: [],
                        borderColor: borderColor,
                        backgroundColor: 'rgba(255, 255, 255, 0.05)',
                        tension: 0.1,
                        pointRadius: 2,
                        pointBackgroundColor: borderColor
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            ticks: { color: '#e0e0e0' },
                            grid: { color: 'rgba(224, 224, 224, 0.2)' }
                        },
                        y: {
                            position: 'left',
                            ticks: { color: borderColor },
                            grid: { color: 'rgba(224, 224, 224, 0.2)' },
                            title: { display: true, text: yAxisTitle, color: borderColor },
                            min: yMin,
                            max: yMax
                        }
                    },
                    // â˜…â˜…â˜… ä¿®æ­£ç‚¹: ã‚ºãƒ¼ãƒ ï¼†ãƒ‘ãƒ³æ©Ÿèƒ½ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³è¨­å®šã‚’è¿½åŠ  â˜…â˜…â˜…
                    plugins: {
                        legend: { display: false },
                        zoom: {
                            pan: {
                                enabled: true, // ãƒ‘ãƒ³(ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«)ã‚’æœ‰åŠ¹åŒ–
                                mode: 'x',     // Xè»¸æ–¹å‘ã®ã¿
                            },
                            zoom: {
                                wheel: {
                                    enabled: true, // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã®ã‚ºãƒ¼ãƒ ã‚’æœ‰åŠ¹åŒ–
                                },
                                pinch: {
                                    enabled: true, // ãƒ”ãƒ³ãƒæ“ä½œã§ã®ã‚ºãƒ¼ãƒ ã‚’æœ‰åŠ¹åŒ–
                                },
                                mode: 'x', // Xè»¸æ–¹å‘ã®ã¿
                            }
                        }
                    }
                }
            });
        }

        const rpmChart = createChart(document.getElementById('rpmChart').getContext('2d'), 'RPM', '#00ffc8', 'RPM', 0, 14000);
        const tpsChart = createChart(document.getElementById('tpsChart').getContext('2d'), 'TPS', '#FFC107', '%', 0, 100);
        const afChart = createChart(document.getElementById('afChart').getContext('2d'), 'A/F', '#FF69B4', 'Lambda', 0.5, 1.5);

        const historyRef = database.ref('history/logs');

        function updateChartData(chart, label, newData) {
            chart.data.labels.push(label);
            chart.data.datasets[0].data.push(newData);
            // 200ä»¶ã‚’è¶…ãˆãŸã‚ãŸã‚Šã‹ã‚‰ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãŸã‚ã« update ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–
            if (chart.data.labels.length > 200) {
                 chart.update('none');
            } else {
                 chart.update();
            }
        }

        historyRef.on('child_added', (snapshot) => {
            const record = snapshot.val();
            if (record && record.timestamp) {
                const date = new Date(record.timestamp);
                if (!isNaN(date.getTime())) { 
                    const timeString = date.toLocaleTimeString('ja-JP');
                    
                    updateChartData(rpmChart, timeString, record.rpm);
                    updateChartData(tpsChart, timeString, record.tps);
                    updateChartData(afChart, timeString, record.lambda);
                }
            }
        });
    </script>
</body>
</html>


