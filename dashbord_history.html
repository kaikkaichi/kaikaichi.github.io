<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CAN Bus History Graph</title>
    <!-- グラフ描画ライブラリ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ★★★ 機能追加: Chart.jsのズーム＆パン プラグイン ★★★ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: #1a1a1a;
            color: #e0e0e0;
            margin: 0; 
            padding: 20px; 
        }
        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .header img {
            height: 50px;
        }
        .header h2 {
            margin: 0;
            text-align: center; 
            color: #FF69B4;
        }
        .nav-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .nav-button {
            background-color: #00ffc8;
            color: #1a1a1a;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            display: inline-block;
            transition: background-color 0.2s;
        }
        .nav-button:hover {
            background-color: #5effe0;
        }
        .chart-container {
            max-width: 1200px;
            margin: 0 auto 20px auto;
            background-color: #2c2c2c;
            padding: 20px;
            border-radius: 8px;
        }
        .chart-container h3 {
            margin-top: 0;
            text-align: center;
            color: #ccc;
            font-weight: normal;
        }
        /* ★追加: グラフ操作の案内メッセージ */
        .chart-info {
            text-align: center;
            font-size: 0.9em;
            color: #888;
            margin-top: -10px;
            margin-bottom: 20px;
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-database-compat.js"></script>
</head>
<body>
    <div class="header">
        <img src="./OFRACロゴ.png" alt="OFRAC Logo">
        <h2>たけちゃんセンサー💘 (履歴グラフ)</h2>
    </div>

    <div class="nav-container">
        <a href="./index.html" target="_blank" class="nav-button">リアルタイム表示へ切り替え</a>
    </div>

    <p class="chart-info">グラフ上でマウスホイールを使うとズーム、ドラッグでスクロール（パン）ができます。</p>

    <div class="chart-container">
        <h3>エンジン回転数 (RPM)</h3>
        <canvas id="rpmChart"></canvas>
    </div>

    <div class="chart-container">
        <h3>スロットルポジション (TPS)</h3>
        <canvas id="tpsChart"></canvas>
    </div>

    <div class="chart-container">
        <h3>空燃比 (A/F Lambda)</h3>
        <canvas id="afChart"></canvas>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBjCn1IyhP_t6c7UQ0ngCaytpQdRfolgQo",
            authDomain: "take-chan-sensor.firebaseapp.com",
            databaseURL: "https://take-chan-sensor-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "take-chan-sensor",
            storageBucket: "take-chan-sensor.appspot.com",
            messagingSenderId: "627148894120",
            appId: "1:627148894120:web:a2218a8028e96d9ac0779d"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        function createChart(ctx, chartLabel, borderColor, yAxisTitle, yMin, yMax) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: chartLabel,
                        data: [],
                        borderColor: borderColor,
                        backgroundColor: 'rgba(255, 255, 255, 0.05)',
                        tension: 0.1,
                        pointRadius: 2,
                        pointBackgroundColor: borderColor
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            ticks: { color: '#e0e0e0' },
                            grid: { color: 'rgba(224, 224, 224, 0.2)' }
                        },
                        y: {
                            position: 'left',
                            ticks: { color: borderColor },
                            grid: { color: 'rgba(224, 224, 224, 0.2)' },
                            title: { display: true, text: yAxisTitle, color: borderColor },
                            min: yMin,
                            max: yMax
                        }
                    },
                    // ★★★ 修正点: ズーム＆パン機能のプラグイン設定を追加 ★★★
                    plugins: {
                        legend: { display: false },
                        zoom: {
                            pan: {
                                enabled: true, // パン(スクロール)を有効化
                                mode: 'x',     // X軸方向のみ
                            },
                            zoom: {
                                wheel: {
                                    enabled: true, // マウスホイールでのズームを有効化
                                },
                                pinch: {
                                    enabled: true, // ピンチ操作でのズームを有効化
                                },
                                mode: 'x', // X軸方向のみ
                            }
                        }
                    }
                }
            });
        }

        const rpmChart = createChart(document.getElementById('rpmChart').getContext('2d'), 'RPM', '#00ffc8', 'RPM', 0, 14000);
        const tpsChart = createChart(document.getElementById('tpsChart').getContext('2d'), 'TPS', '#FFC107', '%', 0, 100);
        const afChart = createChart(document.getElementById('afChart').getContext('2d'), 'A/F', '#FF69B4', 'Lambda', 0.5, 1.5);

        const historyRef = database.ref('history/logs');

        function updateChartData(chart, label, newData) {
            chart.data.labels.push(label);
            chart.data.datasets[0].data.push(newData);
            // 200件を超えたあたりからパフォーマンスのために update のアニメーションを無効化
            if (chart.data.labels.length > 200) {
                 chart.update('none');
            } else {
                 chart.update();
            }
        }

        historyRef.on('child_added', (snapshot) => {
            const record = snapshot.val();
            if (record && record.timestamp) {
                const date = new Date(record.timestamp);
                if (!isNaN(date.getTime())) { 
                    const timeString = date.toLocaleTimeString('ja-JP');
                    
                    updateChartData(rpmChart, timeString, record.rpm);
                    updateChartData(tpsChart, timeString, record.tps);
                    updateChartData(afChart, timeString, record.lambda);
                }
            }
        });
    </script>
</body>
</html>


